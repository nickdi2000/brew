import{p as K,f as u,q as C,B as H,g as Y,C as Z,c as v,o as b,a as t,e as i,i as k,t as d,D as U,n as B,k as r,I as m,T as W,w as q,_ as G,u as ee,s as te,E as se,d as I,l as ae,x as ne,z as X}from"./index-D2AEptfM.js";const le={class:"w-full space-y-3"},oe={class:"text-center"},ie={key:0,class:"text-base font-semibold text-gray-900"},re={key:1,class:"mt-1 text-sm text-gray-500"},de=["aria-label","aria-disabled"],ce={class:"relative flex-1 flex items-center justify-center pointer-events-none"},ue={key:"helper",class:"text-center text-xs text-gray-500"},A=.85,V=8,me=K({__name:"SlideToConfirm",props:{label:{type:String,default:"Slide to confirm"},confirmLabel:{type:String,default:"Keep sliding to confirm"},successLabel:{type:String,default:"Confirmed"},subtitle:{type:String,default:""},title:{type:String,default:""},icon:{type:String,default:"mdi:arrow-right"},successIcon:{type:String,default:"mdi:check"},loadingIcon:{type:String,default:"mdi:loading"},disabled:{type:Boolean,default:!1},loading:{type:Boolean,default:!1},helperText:{type:String,default:""},autoReset:{type:Boolean,default:!0},trackHeight:{type:Number,default:60}},emits:["confirm"],setup(a,{expose:$,emit:N}){const o=a,D=N,p=u(0),g=u(!1),M=u(null),s=u(!1),y=u(0),h=u(0),f=u(null),S=u(null),w=u(null),R=C(()=>Math.max(y.value-h.value-V*2,0)),x=C(()=>g.value&&(o.loading||p.value===1)?R.value:Math.min(R.value,Math.max(0,p.value*R.value))),E=C(()=>{const n=V+h.value/2+x.value;return n<=0?0:Math.min(y.value,n)}),j=C(()=>g.value&&!o.loading||p.value>=A&&!o.loading?o.successIcon:o.icon),F=C(()=>o.loading?"Processing...":g.value?o.successLabel:p.value>=A?o.confirmLabel:o.label),P=()=>{!f.value||!S.value||(y.value=f.value.offsetWidth,h.value=S.value.offsetWidth)},z=n=>Math.min(1,Math.max(0,n)),L=n=>{if(!f.value)return;const T=f.value.getBoundingClientRect(),J=n-T.left-V-h.value/2,Q=z(J/Math.max(R.value,1));p.value=Q},O=()=>{if(s.value){if(s.value=!1,M.value=null,window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",c),o.disabled||o.loading){l();return}p.value>=A?(g.value=!0,p.value=1,D("confirm")):l()}},l=()=>{p.value=0,g.value=!1},e=n=>{!s.value||M.value!==n.pointerId||(n.preventDefault(),L(n.clientX))},c=n=>{M.value===n.pointerId&&(n.preventDefault(),O())},_=n=>{if(!(o.disabled||o.loading)){if(f.value)try{f.value.setPointerCapture(n.pointerId)}catch(T){console.debug("Unable to set pointer capture",T)}P(),s.value=!0,M.value=n.pointerId,L(n.clientX),window.addEventListener("pointermove",e,{passive:!1}),window.addEventListener("pointerup",c,{passive:!1})}};return H(()=>o.loading,(n,T)=>{!n&&T&&o.autoReset&&l()}),H(()=>o.disabled,n=>{n&&l()}),Y(()=>{P(),w.value=new ResizeObserver(()=>{P()}),f.value&&w.value.observe(f.value),window.addEventListener("resize",P)}),Z(()=>{window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",c),window.removeEventListener("resize",P),w.value&&f.value&&w.value.unobserve(f.value),w.value=null}),$({resetSlider:l}),(n,T)=>(b(),v("div",le,[t("div",oe,[a.title?(b(),v("h3",ie,d(a.title),1)):k("",!0),a.subtitle?(b(),v("p",re,d(a.subtitle),1)):k("",!0)]),t("div",{ref_key:"trackRef",ref:f,class:B(["relative flex items-center rounded-full bg-gray-100 shadow-inner overflow-hidden touch-pan-y",[a.disabled||a.loading?"opacity-60 cursor-not-allowed":"cursor-pointer",g.value&&!a.loading?"bg-amber-100":"bg-gray-100"]]),style:U({height:`${a.trackHeight}px`}),role:"button","aria-label":a.title||a.label,"aria-disabled":a.disabled||a.loading,onPointerdown:_},[t("div",{class:"absolute inset-y-0 left-0 bg-amber-500 transition-colors",style:U({width:`${E.value}px`})},null,4),t("div",ce,[t("span",{class:B(["text-sm font-medium transition-colors",[g.value&&!a.loading||p.value>=A?"text-amber-700":"text-gray-600",a.loading?"opacity-70":"opacity-100"]])},d(F.value),3)]),t("div",{ref_key:"handleRef",ref:S,class:B(["absolute top-1 bottom-1 left-1 w-14 rounded-full bg-white shadow-lg flex items-center justify-center transition-transform duration-150 ease-out",[g.value&&!a.loading?"ring-2 ring-amber-400":"ring-0",a.disabled||a.loading?"pointer-events-none":"pointer-events-auto"]]),style:U({transform:`translateX(${x.value}px)`})},[i(r(m),{icon:a.loading?a.loadingIcon:j.value,class:B(a.loading?"h-5 w-5 animate-spin text-amber-600":"h-6 w-6 text-amber-600")},null,8,["icon","class"])],6)],46,de),i(W,{name:"fade-slide",mode:"out-in"},{default:q(()=>[a.helperText?(b(),v("p",ue,d(a.helperText),1)):k("",!0)]),_:1})]))}}),fe=G(me,[["__scopeId","data-v-633bb232"]]),ve={class:"relative bg-gray-50 flex flex-col",style:{"min-height":"calc(100vh - 140px)"}},be={key:0,class:"absolute inset-0 flex justify-center items-center bg-white z-50"},pe={key:1,class:"absolute inset-0 flex flex-col items-center justify-center px-6 bg-white z-50"},xe={class:"mt-2 text-gray-600 text-center"},ge={key:2,class:"flex flex-col flex-1"},he={class:"sticky top-0 z-20 bg-white/95 backdrop-blur-sm border-b border-gray-200"},ye={class:"px-4 py-3 flex items-center"},we=["disabled"],_e={class:"flex-1 overflow-y-auto pb-[220px]"},ke={class:"min-h-full pb-8"},Re={key:0,class:"relative h-64 bg-gray-100"},Ie=["src","alt"],Ce={key:1,class:"absolute inset-0 flex items-center justify-center bg-gradient-to-br from-amber-500 to-amber-600"},Me={key:1,class:"bg-white px-6 py-6"},Se={class:"text-2xl font-bold text-gray-900"},Pe={class:"mt-1 text-sm text-amber-600 font-medium"},Te={key:0,class:"mt-6 space-y-4 pb-4"},$e={class:"text-sm font-semibold text-gray-900 flex items-center gap-2"},Be={class:"mt-1 text-sm text-gray-600"},De={class:"bg-amber-50 border border-amber-100 rounded-xl p-4"},Ee={class:"text-sm font-semibold text-amber-800 flex items-center gap-2"},je={class:"text-sm font-semibold text-gray-900 flex items-center gap-2"},ze={class:"mt-1 text-sm text-gray-600"},Le={key:0},Ae={class:"text-sm font-semibold text-gray-900 flex items-center gap-2"},Ne={class:"mt-1 text-sm text-gray-600"},Fe={class:"border-t border-gray-200 pt-4 space-y-3 text-sm"},Oe={class:"text-sm font-semibold text-gray-900 flex items-center gap-2"},Ue={class:"flex justify-between items-center"},Ve={class:"font-medium text-gray-900"},We={class:"flex justify-between items-center"},qe={class:"font-medium text-gray-900"},He={class:"flex justify-between items-center border-t border-gray-200 pt-3"},Xe={class:"font-semibold text-gray-900"},Ke={class:"inline-flex items-center gap-2"},Ye={key:0,class:"px-6 py-8"},Ge={class:"text-center mb-6"},Je={class:"relative inline-block animate-success-bounce"},Qe={class:"mt-2 text-emerald-200 animate-slide-up-delay"},Ze={class:"bg-emerald-900/40 rounded-xl p-4 border border-emerald-600/30 animate-fade-in-delay-1"},et={class:"flex items-center justify-between"},tt={class:"flex items-center gap-2"},st={class:"text-sm font-semibold text-emerald-200"},at={class:"mt-4 bg-emerald-900/40 rounded-xl p-4 border border-emerald-600/30 animate-fade-in-delay-2"},nt={class:"flex items-center justify-between"},lt={class:"flex items-center gap-2"},ot={class:"text-sm font-semibold text-emerald-200"},it={class:"mt-3 flex items-center justify-between pt-3 border-t border-emerald-600/30"},rt={class:"flex items-center gap-2"},dt={class:"text-sm font-semibold text-emerald-200"},ct={key:0},ut={class:"px-6 pt-4 pb-3 bg-gradient-to-r from-slate-700 to-slate-800 border-b border-slate-600"},mt={class:"flex items-start gap-3"},ft={class:"text-xs text-slate-300 mt-0.5"},vt={class:"relative px-6 py-6 bg-slate-800"},bt={class:"relative z-10"},pt=K({__name:"Redeem",setup(a){const $=ae(),N=ne(),o=te(),D=ee(),p=u(!0),g=u(!1),M=u(""),s=u(null),y=u(!1),h=u(!1),f=u(!1),S=u(null),w=u("");let R=null;const x=C(()=>o.getters["auth/currentMembership"]),E=C(()=>x.value?.organization?.name||""),j=C(()=>{if(!s.value)return!1;const l=x.value?.points??0;return s.value.isAvailable&&l>=s.value.pointsCost&&(!s.value.quantity||s.value.quantity>0)&&(!s.value.expiresAt||new Date(s.value.expiresAt)>new Date)}),F=async()=>{try{p.value=!0,g.value=!1;const l=N.params.id,e=await X.getReward(l);s.value=e}catch(l){g.value=!0,M.value="Failed to load reward details. Please try again.",console.error("Error fetching reward:",l)}finally{p.value=!1}},P=l=>{if(!l)return"mdi:gift";const e={"Birthday Reward":"mdi:cake","VIP Experience":"mdi:star","Mystery Brew":"mdi:flask","Loyalty Bonus":"mdi:heart",Achievement:"mdi:trophy"};if(e[l.name])return e[l.name];switch(l.type){case"product":return"mdi:gift";case"service":return"mdi:sparkles";case"discount":return"mdi:ticket";case"experience":return"mdi:star";default:return"mdi:gift"}},z=()=>{if(!S.value)return;const e=new Date().getTime()-S.value.getTime(),c=Math.floor(e/1e3),_=Math.floor(c/60);if(_>0){const n=c%60;w.value=`${_}m ${n}s ago`}else w.value=`${c}s ago`},L=async()=>{if(!s.value||!j.value||y.value)return;const l=x.value?.points??0;({...x.value});try{y.value=!0,console.info("[Redeem] Starting reward redemption",{rewardId:s.value._id,rewardName:s.value.name,pointsCost:s.value.pointsCost,currentPoints:l,membershipId:x.value?.id});const e=await X.redeemReward(s.value._id,x.value?.id);console.info("[Redeem] Redemption API call successful",{response:e,rewardId:s.value._id}),await o.dispatch("auth/refreshCurrentMembership");const _=o.getters["auth/currentMembership"]?.points??0;console.info("[Redeem] Membership refreshed after redemption",{previousPoints:l,newPoints:_,expectedDeduction:s.value.pointsCost,actualDeduction:l-_}),f.value=!0,S.value=new Date,z(),R=window.setInterval(z,1e3),D("Reward redeemed successfully!","success")}catch(e){console.error("[Redeem] Redemption failed",{error:e.message,stack:e.stack,rewardId:s.value?._id,membershipId:x.value?.id,initialPoints:l});try{await o.dispatch("auth/refreshCurrentMembership"),console.info("[Redeem] Membership state recovered after error")}catch(_){console.error("[Redeem] Failed to recover membership state",_)}let c="Failed to redeem reward. Please try again.";e.message?.includes("Insufficient points")?c="You do not have enough points for this reward.":e.message?.includes("out of stock")?c="This reward is currently out of stock.":e.message?.includes("expired")?c="This reward has expired.":e.message?.includes("not available")?c="This reward is currently not available.":e.message?.includes("not found")&&(c="This reward could not be found."),D(c,"error")}finally{y.value=!1}},O=()=>{h.value=!h.value};return Y(F),se(()=>{R!==null&&clearInterval(R)}),(l,e)=>(b(),v("div",ve,[p.value?(b(),v("div",be,[...e[3]||(e[3]=[t("div",{class:"animate-spin rounded-full h-12 w-12 border-4 border-amber-500 border-t-transparent"},null,-1)])])):g.value?(b(),v("div",pe,[i(r(m),{icon:"mdi:alert-circle",class:"h-16 w-16 text-red-500"}),e[5]||(e[5]=t("h3",{class:"mt-4 text-xl font-semibold text-gray-900"},"Failed to load reward",-1)),t("p",xe,d(M.value),1),t("button",{onClick:e[0]||(e[0]=c=>r($).back()),class:"mt-6 px-6 py-3 rounded-full bg-amber-600 text-white font-medium shadow-lg active:scale-95 transition-transform"},[i(r(m),{icon:"mdi:arrow-left",class:"inline mr-2 h-5 w-5"}),e[4]||(e[4]=I(" Go Back ",-1))])])):(b(),v("div",ge,[t("div",he,[t("div",ye,[t("button",{onClick:e[1]||(e[1]=c=>r($).back()),disabled:y.value,class:"p-2 -ml-2 rounded-full hover:bg-gray-100 active:bg-gray-200 transition-colors"},[i(r(m),{icon:"mdi:arrow-left",class:"h-6 w-6 text-gray-700"})],8,we),e[6]||(e[6]=t("h1",{class:"flex-1 text-center text-lg font-semibold text-gray-900 pr-10"},"Confirm Redemption",-1))])]),t("div",_e,[t("div",ke,[s.value?(b(),v("div",Re,[s.value.base64Image?(b(),v("img",{key:0,src:s.value.base64Image,alt:s.value.name,class:"absolute inset-0 w-full h-full object-cover object-center"},null,8,Ie)):(b(),v("div",Ce,[i(r(m),{icon:P(s.value),class:"h-24 w-24 text-white drop-shadow-lg"},null,8,["icon"])]))])):k("",!0),s.value?(b(),v("div",Me,[t("h2",Se,d(s.value.name),1),t("p",Pe,d(s.value.pointsCost)+" points",1),h.value?(b(),v("div",Te,[t("div",null,[t("h3",$e,[i(r(m),{icon:"mdi:text",class:"h-4 w-4 text-amber-600"}),e[7]||(e[7]=I(" Description ",-1))]),t("p",Be,d(s.value.description),1)]),t("div",De,[t("h3",Ee,[i(r(m),{icon:"mdi:information",class:"h-4 w-4"}),e[8]||(e[8]=I(" How redemption works ",-1))]),e[9]||(e[9]=t("p",{class:"mt-1 text-xs text-amber-700"}," Slide to confirm when you are ready to redeem. Staff will validate this reward in person. ",-1))]),t("div",null,[t("h3",je,[i(r(m),{icon:"mdi:clipboard-text",class:"h-4 w-4 text-amber-600"}),e[10]||(e[10]=I(" Redemption Instructions ",-1))]),t("p",ze,d(s.value.redemptionInstructions||"Show this reward to staff to redeem."),1)]),s.value.termsAndConditions?(b(),v("div",Le,[t("h3",Ae,[i(r(m),{icon:"mdi:shield-check",class:"h-4 w-4 text-amber-600"}),e[11]||(e[11]=I(" Terms & Conditions ",-1))]),t("p",Ne,d(s.value.termsAndConditions),1)])):k("",!0),t("div",Fe,[t("h3",Oe,[i(r(m),{icon:"mdi:coins",class:"h-4 w-4 text-amber-600"}),e[12]||(e[12]=I(" Points Breakdown ",-1))]),t("div",Ue,[e[13]||(e[13]=t("span",{class:"text-gray-500"},"Your Current Points",-1)),t("span",Ve,d(x.value?.points??0),1)]),t("div",We,[e[14]||(e[14]=t("span",{class:"text-gray-500"},"Points Required",-1)),t("span",qe,d(s.value.pointsCost),1)]),t("div",He,[e[15]||(e[15]=t("span",{class:"text-gray-500"},"Remaining Points",-1)),t("span",Xe,d((x.value?.points??0)-s.value.pointsCost),1)])])])):k("",!0),t("button",{class:"mt-6 text-sm font-medium text-amber-600 hover:text-amber-700 active:text-amber-800 focus:outline-none w-full py-3 border border-amber-200 rounded-xl hover:bg-amber-50 active:bg-amber-100 transition-all",onClick:O},[t("span",Ke,[i(r(m),{icon:h.value?"mdi:chevron-up":"mdi:chevron-down",class:"h-5 w-5"},null,8,["icon"]),I(" "+d(h.value?"Hide":"See more")+" details ",1)])])])):k("",!0)])]),t("div",{class:B(["fixed bottom-0 left-0 right-0 max-w-[420px] mx-auto z-30 border-t transition-all duration-700",f.value?"bg-emerald-800 border-emerald-700":"bg-slate-800 border-slate-700"])},[i(W,{"enter-active-class":"transition-all duration-700 ease-out","enter-from-class":"opacity-0 scale-95 translate-y-8","enter-to-class":"opacity-100 scale-100 translate-y-0"},{default:q(()=>[f.value?(b(),v("div",Ye,[t("div",Ge,[t("div",Je,[e[16]||(e[16]=t("div",{class:"absolute inset-0 bg-emerald-400/40 blur-2xl rounded-full animate-pulse-slow"},null,-1)),e[17]||(e[17]=t("div",{class:"absolute inset-0 bg-emerald-300/30 blur-xl rounded-full"},null,-1)),i(r(m),{icon:"mdi:check-circle",class:"relative h-20 w-20 text-emerald-300 drop-shadow-lg animate-success-rotate"})]),e[18]||(e[18]=t("h2",{class:"mt-4 text-2xl font-bold text-white animate-slide-up"},"Redeemed Successfully!",-1)),t("p",Qe,d(s.value?.name),1)]),t("div",Ze,[t("div",et,[t("div",tt,[i(r(m),{icon:"mdi:clock-outline",class:"h-5 w-5 text-emerald-300"}),e[19]||(e[19]=t("span",{class:"text-sm font-medium text-emerald-100"},"Redeemed",-1))]),t("span",st,d(w.value),1)])]),t("div",at,[t("div",nt,[t("div",lt,[i(r(m),{icon:"mdi:minus-circle",class:"h-5 w-5 text-emerald-300"}),e[20]||(e[20]=t("span",{class:"text-sm font-medium text-emerald-100"},"Points Used",-1))]),t("span",ot,d(s.value?.pointsCost),1)]),t("div",it,[t("div",rt,[i(r(m),{icon:"mdi:wallet",class:"h-5 w-5 text-emerald-300"}),e[21]||(e[21]=t("span",{class:"text-sm font-medium text-emerald-100"},"Current Balance",-1))]),t("span",dt,d(x.value?.points??0),1)])]),t("button",{onClick:e[2]||(e[2]=c=>r($).back()),class:"mt-6 w-full py-4 bg-emerald-600 hover:bg-emerald-500 active:bg-emerald-700 text-white font-semibold rounded-xl transition-colors shadow-lg flex items-center justify-center gap-2 animate-fade-in-delay-3"},[i(r(m),{icon:"mdi:arrow-left",class:"h-5 w-5"}),e[22]||(e[22]=I(" Back to Rewards ",-1))])])):k("",!0)]),_:1}),i(W,{"enter-active-class":"transition-all duration-300","leave-active-class":"transition-all duration-300","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:q(()=>[f.value?k("",!0):(b(),v("div",ct,[t("div",ut,[t("div",mt,[i(r(m),{icon:"mdi:account-alert",class:"h-5 w-5 text-blue-400 flex-shrink-0 mt-0.5"}),t("div",null,[e[23]||(e[23]=t("p",{class:"text-xs font-semibold text-white"},"Only swipe when staff is watching",-1)),t("p",ft," Make sure "+d(E.value?`${E.value} staff`:"staff")+" can see your screen before redeeming ",1)])])]),t("div",vt,[e[24]||(e[24]=t("div",{class:"absolute inset-x-6 top-1/2 -translate-y-1/2 h-20 bg-blue-500/30 blur-2xl rounded-full animate-pulse-slow"},null,-1)),e[25]||(e[25]=t("div",{class:"absolute inset-x-6 top-1/2 -translate-y-1/2 h-16 bg-blue-400/20 blur-xl rounded-full"},null,-1)),t("div",bt,[i(fe,{disabled:!j.value,loading:y.value,label:"Slide to redeem","confirm-label":"Keep sliding to confirm","success-label":"Redeemed","success-icon":"mdi:gift-open",icon:"mdi:gesture-swipe-right",onConfirm:L},null,8,["disabled","loading"])])])]))]),_:1})],2)]))]))}}),gt=G(pt,[["__scopeId","data-v-d1a65ab8"]]);export{gt as default};
